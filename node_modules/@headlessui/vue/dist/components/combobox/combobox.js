import{Fragment as Q,computed as C,defineComponent as L,h as J,inject as X,nextTick as A,onMounted as U,onUnmounted as Y,provide as Z,ref as M,toRaw as m,watch as _,watchEffect as q}from"vue";import{Features as K,render as j,omit as W,compact as z}from'../../utils/render.js';import{useId as H}from'../../hooks/use-id.js';import{Keys as V}from'../../keyboard.js';import{calculateActiveIndex as ee,Focus as T}from'../../utils/calculate-active-index.js';import{dom as g}from'../../utils/dom.js';import{useOpenClosed as te,State as $,useOpenClosedProvider as oe}from'../../internal/open-closed.js';import{match as k}from'../../utils/match.js';import{useResolveButtonType as le}from'../../hooks/use-resolve-button-type.js';import{useTreeWalker as ne}from'../../hooks/use-tree-walker.js';import{sortByDomNode as ae}from'../../utils/focus-management.js';import{useOutsideClick as ie}from'../../hooks/use-outside-click.js';import{Hidden as ue,Features as re}from'../../internal/hidden.js';import{objectToFormEntries as se}from'../../utils/form.js';import{useControllable as de}from'../../hooks/use-controllable.js';import{useTrackedPointer as pe}from'../../hooks/use-tracked-pointer.js';import{isMobile as fe}from'../../utils/platform.js';function be(o,O){return o===O}var ve=(s=>(s[s.Open=0]="Open",s[s.Closed=1]="Closed",s))(ve||{}),ce=(s=>(s[s.Single=0]="Single",s[s.Multi=1]="Multi",s))(ce||{}),me=(s=>(s[s.Pointer=0]="Pointer",s[s.Other=1]="Other",s))(me||{});let G=Symbol("ComboboxContext");function B(o){let O=X(G,null);if(O===null){let s=new Error(`<${o} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(s,B),s}return O}let Ne=L({name:"Combobox",emits:{"update:modelValue":o=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},by:{type:[String,Function],default:()=>be},modelValue:{type:[Object,String,Number,Boolean],default:void 0},defaultValue:{type:[Object,String,Number,Boolean],default:void 0},name:{type:String},nullable:{type:Boolean,default:!1},multiple:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(o,{slots:O,attrs:s,emit:P}){let e=M(1),t=M(null),f=M(null),I=M(null),d=M(null),c=M({static:!1,hold:!1}),x=M([]),S=M(null),R=M(1),y=M(!1);function E(n=r=>r){let r=S.value!==null?x.value[S.value]:null,p=ae(n(x.value.slice()),v=>g(v.dataRef.domRef)),a=r?p.indexOf(r):null;return a===-1&&(a=null),{options:p,activeOptionIndex:a}}let l=C(()=>o.multiple?1:0),i=C(()=>o.nullable),[b,w]=de(C(()=>o.modelValue===void 0?k(l.value,{[1]:[],[0]:void 0}):o.modelValue),n=>P("update:modelValue",n),C(()=>o.defaultValue)),u={comboboxState:e,value:b,mode:l,compare(n,r){if(typeof o.by=="string"){let p=o.by;return(n==null?void 0:n[p])===(r==null?void 0:r[p])}return o.by(n,r)},defaultValue:C(()=>o.defaultValue),nullable:i,inputRef:f,labelRef:t,buttonRef:I,optionsRef:d,disabled:C(()=>o.disabled),options:x,change(n){w(n)},activeOptionIndex:C(()=>{if(y.value&&S.value===null&&x.value.length>0){let n=x.value.findIndex(r=>!r.dataRef.disabled);if(n!==-1)return n}return S.value}),activationTrigger:R,optionsPropsRef:c,closeCombobox(){y.value=!1,!o.disabled&&e.value!==1&&(e.value=1,S.value=null)},openCombobox(){if(y.value=!0,o.disabled||e.value===0)return;let n=x.value.findIndex(r=>{let p=m(r.dataRef.value);return k(l.value,{[0]:()=>u.compare(m(u.value.value),m(p)),[1]:()=>m(u.value.value).some(v=>u.compare(m(v),m(p)))})});n!==-1&&(S.value=n),e.value=0},goToOption(n,r,p){if(y.value=!1,o.disabled||d.value&&!c.value.static&&e.value===1)return;let a=E();if(a.activeOptionIndex===null){let h=a.options.findIndex(N=>!N.dataRef.disabled);h!==-1&&(a.activeOptionIndex=h)}let v=ee(n===T.Specific?{focus:T.Specific,id:r}:{focus:n},{resolveItems:()=>a.options,resolveActiveIndex:()=>a.activeOptionIndex,resolveId:h=>h.id,resolveDisabled:h=>h.dataRef.disabled});S.value=v,R.value=p!=null?p:1,x.value=a.options},selectOption(n){let r=x.value.find(a=>a.id===n);if(!r)return;let{dataRef:p}=r;w(k(l.value,{[0]:()=>p.value,[1]:()=>{let a=m(u.value.value).slice(),v=m(p.value),h=a.findIndex(N=>u.compare(v,m(N)));return h===-1?a.push(v):a.splice(h,1),a}}))},selectActiveOption(){if(u.activeOptionIndex.value===null)return;let{dataRef:n,id:r}=x.value[u.activeOptionIndex.value];w(k(l.value,{[0]:()=>n.value,[1]:()=>{let p=m(u.value.value).slice(),a=m(n.value),v=p.findIndex(h=>u.compare(a,m(h)));return v===-1?p.push(a):p.splice(v,1),p}})),u.goToOption(T.Specific,r)},registerOption(n,r){let p={id:n,dataRef:r},a=E(v=>[...v,p]);if(S.value===null){let v=r.value.value;k(l.value,{[0]:()=>u.compare(m(u.value.value),m(v)),[1]:()=>m(u.value.value).some(N=>u.compare(m(N),m(v)))})&&(a.activeOptionIndex=a.options.indexOf(p))}x.value=a.options,S.value=a.activeOptionIndex,R.value=1},unregisterOption(n){var p;u.activeOptionIndex.value!==null&&((p=u.options.value[u.activeOptionIndex.value])==null?void 0:p.id)===n&&(y.value=!0);let r=E(a=>{let v=a.findIndex(h=>h.id===n);return v!==-1&&a.splice(v,1),a});x.value=r.options,S.value=r.activeOptionIndex,R.value=1}};ie([f,I,d],()=>u.closeCombobox(),C(()=>e.value===0)),Z(G,u),oe(C(()=>k(e.value,{[0]:$.Open,[1]:$.Closed})));let F=C(()=>u.activeOptionIndex.value===null?null:x.value[u.activeOptionIndex.value].dataRef.value),D=C(()=>{var n;return(n=g(f))==null?void 0:n.closest("form")});return U(()=>{_([D],()=>{if(!D.value||o.defaultValue===void 0)return;function n(){u.change(o.defaultValue)}return D.value.addEventListener("reset",n),()=>{var r;(r=D.value)==null||r.removeEventListener("reset",n)}},{immediate:!0})}),()=>{let{name:n,disabled:r,...p}=o,a={open:e.value===0,disabled:r,activeIndex:u.activeOptionIndex.value,activeOption:F.value,value:b.value};return J(Q,[...n!=null&&b.value!=null?se({[n]:b.value}).map(([v,h])=>J(ue,z({features:re.Hidden,key:v,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:v,value:h}))):[],j({theirProps:{...s,...W(p,["modelValue","defaultValue","nullable","multiple","onUpdate:modelValue","by"])},ourProps:{},slot:a,slots:O,attrs:s,name:"Combobox"})])}}}),He=L({name:"ComboboxLabel",props:{as:{type:[Object,String],default:"label"},id:{type:String,default:()=>`headlessui-combobox-label-${H()}`}},setup(o,{attrs:O,slots:s}){let P=B("ComboboxLabel");function e(){var t;(t=g(P.inputRef))==null||t.focus({preventScroll:!0})}return()=>{let t={open:P.comboboxState.value===0,disabled:P.disabled.value},{id:f,...I}=o,d={id:f,ref:P.labelRef,onClick:e};return j({ourProps:d,theirProps:I,slot:t,attrs:O,slots:s,name:"ComboboxLabel"})}}}),Ke=L({name:"ComboboxButton",props:{as:{type:[Object,String],default:"button"},id:{type:String,default:()=>`headlessui-combobox-button-${H()}`}},setup(o,{attrs:O,slots:s,expose:P}){let e=B("ComboboxButton");P({el:e.buttonRef,$el:e.buttonRef});function t(d){e.disabled.value||(e.comboboxState.value===0?e.closeCombobox():(d.preventDefault(),e.openCombobox()),A(()=>{var c;return(c=g(e.inputRef))==null?void 0:c.focus({preventScroll:!0})}))}function f(d){switch(d.key){case V.ArrowDown:d.preventDefault(),d.stopPropagation(),e.comboboxState.value===1&&e.openCombobox(),A(()=>{var c;return(c=e.inputRef.value)==null?void 0:c.focus({preventScroll:!0})});return;case V.ArrowUp:d.preventDefault(),d.stopPropagation(),e.comboboxState.value===1&&(e.openCombobox(),A(()=>{e.value.value||e.goToOption(T.Last)})),A(()=>{var c;return(c=e.inputRef.value)==null?void 0:c.focus({preventScroll:!0})});return;case V.Escape:if(e.comboboxState.value!==0)return;d.preventDefault(),e.optionsRef.value&&!e.optionsPropsRef.value.static&&d.stopPropagation(),e.closeCombobox(),A(()=>{var c;return(c=e.inputRef.value)==null?void 0:c.focus({preventScroll:!0})});return}}let I=le(C(()=>({as:o.as,type:O.type})),e.buttonRef);return()=>{var R,y;let d={open:e.comboboxState.value===0,disabled:e.disabled.value,value:e.value.value},{id:c,...x}=o,S={ref:e.buttonRef,id:c,type:I.value,tabindex:"-1","aria-haspopup":"listbox","aria-controls":(R=g(e.optionsRef))==null?void 0:R.id,"aria-expanded":e.disabled.value?void 0:e.comboboxState.value===0,"aria-labelledby":e.labelRef.value?[(y=g(e.labelRef))==null?void 0:y.id,c].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:f,onClick:t};return j({ourProps:S,theirProps:x,slot:d,attrs:O,slots:s,name:"ComboboxButton"})}}}),$e=L({name:"ComboboxInput",props:{as:{type:[Object,String],default:"input"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},displayValue:{type:Function},defaultValue:{type:String,default:void 0},id:{type:String,default:()=>`headlessui-combobox-input-${H()}`}},emits:{change:o=>!0},setup(o,{emit:O,attrs:s,slots:P,expose:e}){let t=B("ComboboxInput"),f={value:!1};e({el:t.inputRef,$el:t.inputRef});let I=C(()=>{var i;let l=t.value.value;return g(t.inputRef)?typeof o.displayValue!="undefined"&&l!==void 0?(i=o.displayValue(l))!=null?i:"":typeof l=="string"?l:"":""});U(()=>{_([I,t.comboboxState],([l,i],[b,w])=>{if(f.value)return;let u=g(t.inputRef);u&&(w===0&&i===1||l!==b)&&(u.value=l)},{immediate:!0}),_([t.comboboxState],([l],[i])=>{if(l===0&&i===1){let b=g(t.inputRef);if(!b)return;let w=b.value,{selectionStart:u,selectionEnd:F,selectionDirection:D}=b;b.value="",b.value=w,D!==null?b.setSelectionRange(u,F,D):b.setSelectionRange(u,F)}})});let d=M(!1);function c(){d.value=!0}function x(){setTimeout(()=>{d.value=!1})}function S(l){switch(f.value=!0,l.key){case V.Backspace:case V.Delete:if(t.mode.value!==0||!t.nullable.value)return;let i=l.currentTarget;requestAnimationFrame(()=>{if(i.value===""){t.change(null);let b=g(t.optionsRef);b&&(b.scrollTop=0),t.goToOption(T.Nothing)}});break;case V.Enter:if(f.value=!1,t.comboboxState.value!==0||d.value)return;if(l.preventDefault(),l.stopPropagation(),t.activeOptionIndex.value===null){t.closeCombobox();return}t.selectActiveOption(),t.mode.value===0&&t.closeCombobox();break;case V.ArrowDown:return f.value=!1,l.preventDefault(),l.stopPropagation(),k(t.comboboxState.value,{[0]:()=>t.goToOption(T.Next),[1]:()=>t.openCombobox()});case V.ArrowUp:return f.value=!1,l.preventDefault(),l.stopPropagation(),k(t.comboboxState.value,{[0]:()=>t.goToOption(T.Previous),[1]:()=>{t.openCombobox(),A(()=>{t.value.value||t.goToOption(T.Last)})}});case V.Home:if(l.shiftKey)break;return f.value=!1,l.preventDefault(),l.stopPropagation(),t.goToOption(T.First);case V.PageUp:return f.value=!1,l.preventDefault(),l.stopPropagation(),t.goToOption(T.First);case V.End:if(l.shiftKey)break;return f.value=!1,l.preventDefault(),l.stopPropagation(),t.goToOption(T.Last);case V.PageDown:return f.value=!1,l.preventDefault(),l.stopPropagation(),t.goToOption(T.Last);case V.Escape:if(f.value=!1,t.comboboxState.value!==0)return;l.preventDefault(),t.optionsRef.value&&!t.optionsPropsRef.value.static&&l.stopPropagation(),t.closeCombobox();break;case V.Tab:if(f.value=!1,t.comboboxState.value!==0)return;t.mode.value===0&&t.selectActiveOption(),t.closeCombobox();break}}function R(l){t.openCombobox(),O("change",l)}function y(){f.value=!1}let E=C(()=>{var l,i,b,w;return(w=(b=(i=o.defaultValue)!=null?i:t.defaultValue.value!==void 0?(l=o.displayValue)==null?void 0:l.call(o,t.defaultValue.value):null)!=null?b:t.defaultValue.value)!=null?w:""});return()=>{var D,n,r,p,a,v;let l={open:t.comboboxState.value===0},{id:i,displayValue:b,onChange:w,...u}=o,F={"aria-controls":(D=t.optionsRef.value)==null?void 0:D.id,"aria-expanded":t.disabled.value?void 0:t.comboboxState.value===0,"aria-activedescendant":t.activeOptionIndex.value===null||(n=t.options.value[t.activeOptionIndex.value])==null?void 0:n.id,"aria-labelledby":(a=(r=g(t.labelRef))==null?void 0:r.id)!=null?a:(p=g(t.buttonRef))==null?void 0:p.id,"aria-autocomplete":"list",id:i,onCompositionstart:c,onCompositionend:x,onKeydown:S,onInput:R,onBlur:y,role:"combobox",type:(v=s.type)!=null?v:"text",tabIndex:0,ref:t.inputRef,defaultValue:E.value};return j({ourProps:F,theirProps:u,slot:l,attrs:s,slots:P,features:K.RenderStrategy|K.Static,name:"ComboboxInput"})}}}),Ue=L({name:"ComboboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},hold:{type:[Boolean],default:!1}},setup(o,{attrs:O,slots:s,expose:P}){let e=B("ComboboxOptions"),t=`headlessui-combobox-options-${H()}`;P({el:e.optionsRef,$el:e.optionsRef}),q(()=>{e.optionsPropsRef.value.static=o.static}),q(()=>{e.optionsPropsRef.value.hold=o.hold});let f=te(),I=C(()=>f!==null?(f.value&$.Open)===$.Open:e.comboboxState.value===0);return ne({container:C(()=>g(e.optionsRef)),enabled:C(()=>e.comboboxState.value===0),accept(d){return d.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:d.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(d){d.setAttribute("role","none")}}),()=>{var S,R,y;let d={open:e.comboboxState.value===0},c={"aria-labelledby":(y=(S=g(e.labelRef))==null?void 0:S.id)!=null?y:(R=g(e.buttonRef))==null?void 0:R.id,id:t,ref:e.optionsRef,role:"listbox","aria-multiselectable":e.mode.value===1?!0:void 0},x=W(o,["hold"]);return j({ourProps:c,theirProps:x,slot:d,attrs:O,slots:s,features:K.RenderStrategy|K.Static,visible:I.value,name:"ComboboxOptions"})}}}),_e=L({name:"ComboboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(o,{slots:O,attrs:s,expose:P}){let e=B("ComboboxOption"),t=`headlessui-combobox-option-${H()}`,f=M(null);P({el:f,$el:f});let I=C(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===t:!1),d=C(()=>k(e.mode.value,{[0]:()=>e.compare(m(e.value.value),m(o.value)),[1]:()=>m(e.value.value).some(i=>e.compare(m(i),m(o.value)))})),c=C(()=>({disabled:o.disabled,value:o.value,domRef:f}));U(()=>e.registerOption(t,c)),Y(()=>e.unregisterOption(t)),q(()=>{e.comboboxState.value===0&&I.value&&e.activationTrigger.value!==0&&A(()=>{var i,b;return(b=(i=g(f))==null?void 0:i.scrollIntoView)==null?void 0:b.call(i,{block:"nearest"})})});function x(i){if(o.disabled)return i.preventDefault();e.selectOption(t),e.mode.value===0&&e.closeCombobox(),fe()||requestAnimationFrame(()=>{var b;return(b=g(e.inputRef))==null?void 0:b.focus()})}function S(){if(o.disabled)return e.goToOption(T.Nothing);e.goToOption(T.Specific,t)}let R=pe();function y(i){R.update(i)}function E(i){R.wasMoved(i)&&(o.disabled||I.value||e.goToOption(T.Specific,t,0))}function l(i){R.wasMoved(i)&&(o.disabled||I.value&&(e.optionsPropsRef.value.hold||e.goToOption(T.Nothing)))}return()=>{let{disabled:i}=o,b={active:I.value,selected:d.value,disabled:i},w={id:t,ref:f,role:"option",tabIndex:i===!0?void 0:-1,"aria-disabled":i===!0?!0:void 0,"aria-selected":d.value,disabled:void 0,onClick:x,onFocus:S,onPointerenter:y,onMouseenter:y,onPointermove:E,onMousemove:E,onPointerleave:l,onMouseleave:l};return j({ourProps:w,theirProps:o,slot:b,attrs:s,slots:O,name:"ComboboxOption"})}}});export{Ne as Combobox,Ke as ComboboxButton,$e as ComboboxInput,He as ComboboxLabel,_e as ComboboxOption,Ue as ComboboxOptions};
